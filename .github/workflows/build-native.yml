name: Build Native Libraries

# What this workflow does:
# 1. Builds the RE2 wrapper library for 4 platforms:
#    - macOS x86_64 (Intel Macs)
#    - macOS aarch64 (Apple Silicon)
#    - Linux x86_64 (Intel/AMD servers)
#    - Linux aarch64 (ARM servers)
#
# 2. Each platform gets a separate job that:
#    - Checks out the code
#    - Runs our build.sh script (which downloads RE2, compiles it, compiles wrapper)
#    - Uploads the resulting .dylib/.so file as an artifact
#
# 3. Artifacts can be downloaded from the GitHub Actions UI and placed in:
#    libre2-core/src/main/resources/native/{platform}/

on:
  # Trigger this workflow ONLY manually from GitHub UI
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Target branch to create PR against'
        required: true
        default: 'development'
        type: string

jobs:
  # ============================================================================
  # macOS Builds (native runners, no Docker needed)
  # ============================================================================

  build-macos-x86_64:
    name: Build macOS x86_64
    runs-on: macos-15-intel  # Intel Mac runner (updated from deprecated macos-13)
    environment: native-builds  # Use protected environment for commit hashes

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install dependencies
        run: |
          # Install jq for JSON parsing (signature verification)
          brew install jq

          # Verify cmake is available
          cmake --version
          jq --version
          echo "JAVA_HOME: $JAVA_HOME"

      - name: Build RE2 wrapper
        env:
          RE2_COMMIT: ${{ vars.RE2_COMMIT }}
          RE2_RELEASE_VERSION: ${{ vars.RE2_RELEASE_VERSION }}
          ABSEIL_COMMIT: ${{ vars.ABSEIL_COMMIT }}
          ABSEIL_RELEASE_VERSION: ${{ vars.ABSEIL_RELEASE_VERSION }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd native
          ./scripts/build.sh

      - name: Verify library
        run: |
          cd native/build

          # Check it's a valid Mach-O library
          file libre2.dylib

          # Check dependencies (should only be system libs)
          echo "Dependencies:"
          otool -L libre2.dylib

          # Check exported JNI functions
          echo "Exported JNI functions:"
          nm -g libre2.dylib | grep ' T ' | grep 'Java_com_axonops_libre2_jni_RE2NativeJNI'

          # Verify all 9 JNI functions exist
          FUNC_COUNT=$(nm -g libre2.dylib | grep ' T ' | grep 'Java_com_axonops_libre2_jni_RE2NativeJNI' | wc -l)
          if [ "$FUNC_COUNT" -ne 9 ]; then
            echo "ERROR: Expected 9 exported JNI functions, found $FUNC_COUNT"
            exit 1
          fi

          echo "✅ Library verification passed"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libre2-macos-x86_64
          path: native/build/libre2.dylib
          retention-days: 30

  build-macos-aarch64:
    name: Build macOS aarch64 (Apple Silicon)
    runs-on: macos-latest  # M1/M2/M3 Mac runner
    environment: native-builds  # Use protected environment for commit hashes

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install dependencies
        run: |
          # Install jq for JSON parsing (signature verification)
          brew install jq

          # Verify tools are available
          cmake --version
          jq --version
          echo "JAVA_HOME: $JAVA_HOME"

      - name: Build RE2 wrapper
        env:
          RE2_COMMIT: ${{ vars.RE2_COMMIT }}
          RE2_RELEASE_VERSION: ${{ vars.RE2_RELEASE_VERSION }}
          ABSEIL_COMMIT: ${{ vars.ABSEIL_COMMIT }}
          ABSEIL_RELEASE_VERSION: ${{ vars.ABSEIL_RELEASE_VERSION }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd native
          ./scripts/build.sh

      - name: Verify library
        run: |
          cd native/build

          # Check it's a valid Mach-O library
          file libre2.dylib

          # Check dependencies
          echo "Dependencies:"
          otool -L libre2.dylib

          # Check exported JNI functions
          echo "Exported JNI functions:"
          nm -g libre2.dylib | grep ' T ' | grep 'Java_com_axonops_libre2_jni_RE2NativeJNI'

          # Verify all 9 JNI functions exist
          FUNC_COUNT=$(nm -g libre2.dylib | grep ' T ' | grep 'Java_com_axonops_libre2_jni_RE2NativeJNI' | wc -l)
          if [ "$FUNC_COUNT" -ne 9 ]; then
            echo "ERROR: Expected 9 exported JNI functions, found $FUNC_COUNT"
            exit 1
          fi

          echo "✅ Library verification passed"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libre2-macos-aarch64
          path: native/build/libre2.dylib
          retention-days: 30

  # ============================================================================
  # Linux Builds (using Docker for clean, reproducible builds)
  # ============================================================================

  build-linux-x86_64:
    name: Build Linux x86_64 (Rocky 8)
    runs-on: ubuntu-latest
    environment: native-builds  # Use protected environment for commit hashes

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image with cache
        uses: docker/build-push-action@v5
        with:
          context: ./native
          load: true
          tags: re2-builder
          cache-from: type=gha,scope=linux-x86_64-${{ hashFiles('native/Dockerfile') }}
          cache-to: type=gha,mode=max,scope=linux-x86_64-${{ hashFiles('native/Dockerfile') }}

      - name: Build RE2 wrapper
        env:
          RE2_COMMIT: ${{ vars.RE2_COMMIT }}
          RE2_RELEASE_VERSION: ${{ vars.RE2_RELEASE_VERSION }}
          ABSEIL_COMMIT: ${{ vars.ABSEIL_COMMIT }}
          ABSEIL_RELEASE_VERSION: ${{ vars.ABSEIL_RELEASE_VERSION }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd native

          # Run the container to compile RE2 + wrapper
          # Pass environment variables into container
          docker run --rm \
            -e RE2_COMMIT \
            -e RE2_RELEASE_VERSION \
            -e ABSEIL_COMMIT \
            -e ABSEIL_RELEASE_VERSION \
            -e GITHUB_TOKEN \
            -v "$(pwd):/output" \
            re2-builder \
            sh -c "./build.sh && cp build/libre2.so /output/"

      - name: Verify library
        run: |
          cd native

          # Check it's a valid ELF library
          file libre2.so

          # Check dependencies (should only be system libs)
          echo "Dependencies:"
          docker run --rm -v "$(pwd):/output" re2-builder ldd /output/libre2.so

          # Check exported JNI functions
          echo "Exported JNI functions:"
          docker run --rm -v "$(pwd):/output" re2-builder nm -D /output/libre2.so | grep ' T ' | grep 'Java_com_axonops_libre2_jni_RE2NativeJNI'

          # Verify all 9 JNI functions exist
          FUNC_COUNT=$(docker run --rm -v "$(pwd):/output" re2-builder nm -D /output/libre2.so | grep ' T ' | grep 'Java_com_axonops_libre2_jni_RE2NativeJNI' | wc -l)
          if [ "$FUNC_COUNT" -ne 9 ]; then
            echo "ERROR: Expected 9 exported JNI functions, found $FUNC_COUNT"
            exit 1
          fi

          echo "✅ Library verification passed"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libre2-linux-x86_64
          path: native/libre2.so
          retention-days: 30

  build-linux-aarch64:
    name: Build Linux aarch64 (Rocky 8 ARM64)
    runs-on: ubuntu-latest
    environment: native-builds  # Use protected environment for commit hashes

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image with cache (ARM64)
        uses: docker/build-push-action@v5
        with:
          context: ./native
          platforms: linux/arm64
          load: true
          tags: re2-builder-arm64
          cache-from: type=gha,scope=linux-aarch64-${{ hashFiles('native/Dockerfile') }}
          cache-to: type=gha,mode=max,scope=linux-aarch64-${{ hashFiles('native/Dockerfile') }}

      - name: Build RE2 wrapper (ARM64)
        env:
          RE2_COMMIT: ${{ vars.RE2_COMMIT }}
          RE2_RELEASE_VERSION: ${{ vars.RE2_RELEASE_VERSION }}
          ABSEIL_COMMIT: ${{ vars.ABSEIL_COMMIT }}
          ABSEIL_RELEASE_VERSION: ${{ vars.ABSEIL_RELEASE_VERSION }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd native

          # Run ARM64 container (QEMU will emulate if not native ARM)
          # Pass environment variables into container
          docker run --rm --platform linux/arm64 \
            -e RE2_COMMIT \
            -e RE2_RELEASE_VERSION \
            -e ABSEIL_COMMIT \
            -e ABSEIL_RELEASE_VERSION \
            -e GITHUB_TOKEN \
            -v "$(pwd):/output" \
            re2-builder-arm64 \
            sh -c "./build.sh && cp build/libre2.so /output/"

      - name: Verify library
        run: |
          cd native

          # Check it's a valid ELF library
          file libre2.so

          # Check dependencies
          echo "Dependencies:"
          docker run --rm --platform linux/arm64 -v "$(pwd):/output" re2-builder-arm64 ldd /output/libre2.so

          # Check exported JNI functions
          echo "Exported JNI functions:"
          docker run --rm --platform linux/arm64 -v "$(pwd):/output" re2-builder-arm64 nm -D /output/libre2.so | grep ' T ' | grep 'Java_com_axonops_libre2_jni_RE2NativeJNI'

          # Verify all 9 JNI functions exist
          FUNC_COUNT=$(docker run --rm --platform linux/arm64 -v "$(pwd):/output" re2-builder-arm64 nm -D /output/libre2.so | grep ' T ' | grep 'Java_com_axonops_libre2_jni_RE2NativeJNI' | wc -l)
          if [ "$FUNC_COUNT" -ne 9 ]; then
            echo "ERROR: Expected 9 exported JNI functions, found $FUNC_COUNT"
            exit 1
          fi

          echo "✅ Library verification passed"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libre2-linux-aarch64
          path: native/libre2.so
          retention-days: 30

  # ============================================================================
  # Commit job - downloads all artifacts and commits to a new branch
  # ============================================================================

  commit-libraries:
    name: Commit Native Libraries
    needs: [build-macos-x86_64, build-macos-aarch64, build-linux-x86_64, build-linux-aarch64]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Organize libraries into resources directory
        run: |
          # Create resources directory structure (multi-module: libre2-core)
          mkdir -p libre2-core/src/main/resources/native/{darwin-x86_64,darwin-aarch64,linux-x86_64,linux-aarch64}

          # Copy libraries to correct locations
          cp artifacts/libre2-macos-x86_64/libre2.dylib libre2-core/src/main/resources/native/darwin-x86_64/
          cp artifacts/libre2-macos-aarch64/libre2.dylib libre2-core/src/main/resources/native/darwin-aarch64/
          cp artifacts/libre2-linux-x86_64/libre2.so libre2-core/src/main/resources/native/linux-x86_64/
          cp artifacts/libre2-linux-aarch64/libre2.so libre2-core/src/main/resources/native/linux-aarch64/

          # Show what we got
          echo "Libraries copied:"
          ls -lh libre2-core/src/main/resources/native/*/libre2.*

      - name: Create branch and commit
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create new branch with timestamp
          BRANCH_NAME="native-libs-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"

          # Add libraries (multi-module: libre2-core)
          git add -f libre2-core/src/main/resources/native/*/libre2.*

          # Commit with heredoc
          git commit -m "$(cat <<'EOF'
          Add compiled JNI native libraries for all platforms

          Built from RE2 2025-11-05 and Abseil 20250814.1

          Now using JNI instead of JNA for improved performance.

          Libraries:
          - darwin-x86_64/libre2.dylib (macOS Intel)
          - darwin-aarch64/libre2.dylib (macOS Apple Silicon)
          - linux-x86_64/libre2.so (Linux x86_64)
          - linux-aarch64/libre2.so (Linux ARM64)

          All libraries are self-contained with only system dependencies.
          EOF
          )"

          # Push branch
          git push origin "$BRANCH_NAME"

          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --base "${{ github.event.inputs.target_branch }}" \
            --head "$BRANCH_NAME" \
            --title "Update JNI native libraries (RE2 2025-11-05)" \
            --body "$(cat <<'PRBODY'
          ## JNI Native Libraries Update

          This PR adds/updates the compiled JNI native RE2 libraries for all supported platforms.

          **Now using JNI instead of JNA for improved performance** (~2-3x faster native calls).

          ### Built Libraries
          - ✅ darwin-x86_64/libre2.dylib (macOS Intel)
          - ✅ darwin-aarch64/libre2.dylib (macOS Apple Silicon)
          - ✅ linux-x86_64/libre2.so (Linux x86_64)
          - ✅ linux-aarch64/libre2.so (Linux ARM64)

          ### Versions
          - RE2: 2025-11-05
          - Abseil: 20250814.1

          ### Verification
          All libraries export 9 JNI functions and are self-contained with only system dependencies.

          ### Next Steps
          1. Review library sizes and dependencies
          2. Merge this PR
          3. Java code will automatically load correct library for platform
          PRBODY
          )"
